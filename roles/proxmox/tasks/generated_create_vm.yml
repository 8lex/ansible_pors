#######################################################################
# IMPORTANT
# ----------
# This file gets AUTO-GENERATED! Any changes within this file
# gets lost on the next run as it is part of a jinja template located
# here: roles/googlecp/templates/create_instance.j2
#
# The Proxmox ansible modules do not offer to attach disks to an already
# running instance.
# supports only virtio disks.
######################################################################

- name: "Create Proxmox VM splasd"
  community.general.proxmox_kvm:
        proxmox_default_behavior: compatibility
        node: "hotel"
        api_user: "ansible@pve"
        api_token_id: "proxmoxer"
        api_token_secret: "{{ proxmox.node[px_var].api_token_secret }}"
        api_host: "hotel.sedi.one"
        clone: "suse-ansible-template"
        name: "{{ item }}"
        description: "{{ server_notes }} on {{ datetime }}"
        storage: "ssd2"
        virtio: 
            virtio1: "ssd2:20,format=qcow2"
            virtio2: "ssd2:1,format=qcow2"
        bootdisk: "virtio1"
        timeout: 120
  register: clone_output
  failed_when: clone_output.msg != (clone_output.msg | regex_search("VM {{ item }} with newid .* cloned from vm with vmid .*"))
  run_once: True
  loop: "{{ server_hostname }}"
  loop_control:
    pause: 15
